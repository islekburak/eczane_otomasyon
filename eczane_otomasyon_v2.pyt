import os, argparse, textwrap
import pandas as pd
import numpy as np


parser=argparse.ArgumentParser(
	prog="eczane_otomasyon.py",
    usage="python3 %(prog)s [options] <path_of_file>",
    description=textwrap.dedent("""\
        authors:    islekbro  https://github.com/islekburak/
        contact:    islekburak@gmail.com/"""),
    add_help=True,
    formatter_class=argparse.RawTextHelpFormatter, 
    epilog=textwrap.dedent("""\
===========================================================================================================================================
This program helps you to detect original position of protein residues. You should enter the residue position of alignment file (as -idx).
#   REQUIRED
    ========
> with "-i" flag    (--inputfiles)	,   You should specify your input files path.
> with "-d" flag    (--depofiles)	,   You should specify your depo file path.
> with "-o" flag    (--outfile)		,   You should enter an path+string for a name of your output.
===========================================================================================================================================
"""))


import os, argparse, textwrap
import pandas as pd
import numpy as np


parser=argparse.ArgumentParser()
parser.add_argument("-i","--infiles", metavar="<input query path>", required=True, help="Write the path of input query (i.e. /home/Desktop/)")
parser.add_argument("-d","--depo", metavar="<depo query path>", required=True, help="Write the path of depo query (i.e. /home/Desktop/)")
parser.add_argument("-o","--out", metavar="<output name>", required=True, help="Write the name of an output (i.e. /home/Desktop/out.csv)")
args=parser.parse_args()





#getting input path
query_path=args.infiles
depo_query=args.depo
outfile=args.out

#query_path="/Users/islekbro/Desktop/dilos2/inputs/"
query_files = os.listdir(query_path)

dfs=[]
for i in query_files:
	k= pd.read_csv(query_path+i,sep=";")
	k = k[['DEPO GRUBU', 'GLN', 'ECZANE ADI', 'BARKOD', 'ÜRÜN ADI', 'ADET', 'MF']]
	k = k.astype({'DEPO GRUBU':object, 'GLN':int, 'ECZANE ADI':object, 'BARKOD':int, 'ÜRÜN ADI':object, 'ADET':int, 'MF': int})
	k = k.apply(lambda x: x.str.upper() if x.dtype == "object" else x)
	k = k.apply(lambda x: x.str.strip() if x.dtype == "object" else x)
	k = k.apply(lambda x: x.str.replace("Ç", "C") if x.dtype == "object" else x)
	k = k.apply(lambda x: x.str.replace("Ş", "S") if x.dtype == "object" else x)
	k = k.apply(lambda x: x.str.replace("Ğ", "G") if x.dtype == "object" else x)
	k = k.apply(lambda x: x.str.replace("İ", "I") if x.dtype == "object" else x)
	k = k.apply(lambda x: x.str.replace("Ö", "O") if x.dtype == "object" else x)
	k = k.apply(lambda x: x.str.replace("Ü", "U") if x.dtype == "object" else x)
	dfs.append(k)

fin = pd.concat(dfs)
fin = fin.astype({'DEPO GRUBU':object, 'GLN':int, 'ECZANE ADI':object, 'BARKOD':int, 'ÜRÜN ADI':object, 'ADET':int, 'MF': int})

##########################################################################################################################################################################################


eczane_dict={

"YENI DILEK":8680001285846,
"ELIT":8680001522453,
"BILEN":8680001661466,
"VANILYA":8680001626977,
"YUNUS":8680001566815,
"LAGUN":8680001496310,
"CADDEBOSTAN PLUS":8680001381289,
"EMRE":8680001450879,
"MUNGAN":8680001598809,
"KRISTAL":8680001285150,
"PAMUK":8680001293759,
"HEKIMOGLU":8680001537334,
"BOSTANCI MERKEZ":8680001240388,
"LAL":8680001288212,
"KOKLU":8680001540303,
"ELIF":8680001294916,
"GOZTEPE MERKEZ":8680001217212,
"TOPRAK":8680001346059,
"ARZU":8680001476299,
"CADDE SAGLIK":8680001639090,
"PINAR":8680001286188,
"ERENKOY":8680001515967,
"MISRA KAN":8680001636013,
"MIRAY":8680001483631,
"KALYONCU":8680001286003,
"KELEBEK":8680001648948,
"NILGUN":8680001684175,
"BOGAZICI":8680001601653,
"RENK":8680001632862,
"SOLEY":8680001285051,
"RUYA":8680001295616,
"UTKU":8680001658961,
"YENISEHIR":8680001282029,
"AKSU":8680001213917,
"KOZYATAGI GUL":8680001295548,
"TANYER":8680001296552,
"SAFRANBOLU":8680001603961,
"EMINE":8680001290956,
"ERENKOY PINAR":8680001599776,
"CEMRE":8680001573684,
"KAMELYA":8680001439591,
"KOZYATAGI":8680001547166,
"IDEAL":8680001687190,
"JULIDE":8680001597178,
"EFES":8680001285013,
"ANIK":8680001466603,
"KORU":8680001496471,
"MAYA":8680001682546,
"PELIKAN":8680001428403,
"TEPEGOZ":8680001450299,
"YENI ZEYNEP":8680001294756,
"SEVIMLI":8680001352234,
"ARTI":8680001478286,
"CADDEBASI":8680001482290,
"FUNDA":8680001289936,
"TULIN":8680001290192,
"KOZYATAGI MARMARA":8680001425051,
"ATA":8680001285280,
"BEGONVIL":8680001630394,
"KOZA":8680001262847,
"CANKAYA":8680001520725,
"TURKUAZ":8680001419913,
"SUNA":8680001290116,
"19 MAYIS":8680001488452,
"SEHIR":8680001303762,
"BIZIM EVIN":8680001292769,
"BERUL":8680001550012,
"YASEMIN":8680001291540,
"UZUN BOSTANCI":8680001678419,
"AYNUR":8680001290918,
"GELINCIK":8680001290093,
"YESIM":8680001285570,
"SERDIL":8680001515196,
"GULEC":8680001506293,
"BURKAY":8680001292776,
"EVRANOS":8680001282128,
"CUMHURIYET":8680001620654,
"FERHAN":8680001212248,
"YENI HATBOYU":8680001290253,
"GULNAZ":8680001632596,
"CANKIZ":8680001569229,
"YENI BURKAY":8680001598151,
"NAZLI":8680001286171,
"YENI BURAK":8680001295685,
"MARMARA":8680001292875,
"CIGDEM GURSOY":8680001465835,
"RUZGAR":8680001287000,
"INTEPE":8680001686490,
"DOGA":8680001431236,
"OMERPASA":8680001445837,
"DOGUS":8680001286102,
"ONIKILER":8680001292080,
"ANIL":8680001412501,
"ALP":8680001679539,
"KOZYATAGI MELTEM":8680001623150,
"BUYUK":8680001285983,
"CAGLA":8680001523092,
"ATASER":8680001294831,
"GULNUR":8680001686582,
"ALIOGLU":8680001294787,
"REYHAN":8680001286201,
"AREL":8680001431601,
"AKTAS":8680001124879,
"TEKDEMIR":8680001293551,
"MERKEZ":8680001552153,
"ONUR 83":8680001282142,
"BIZIM":8680001215362,
"DOGAN":8680001405435,
"GOZTEPE":8680001617968,
"KOCKAN":8680001285044,
"DOGRU":8680001125777,
"FLORA":8680001676125,
"MUGE":8680001663453,
"GURSEL GULSEN":8680001282104,
"BATUHAN":8680001286034,
"YALVAC":8680001282265,
"SAKACI":8680001285631,
"OZGUNES":8680001285914,
"IDIL":8680001439829,
"IREM":8680001601202,
"YAGMUR":8680001282005,
"KOZYATAGI DENIZ":8680001454235,
"INCIR ZUMRUT":8680001482160,
"IREM OZDOGAN":8680001456048,
"CIGDEM":8680001417216,
"KOPRULULER":8680001482122,
"NAZAN":8680001290161,
"YENI GUVEN":8680001466986,
"TANIS":8680001295654,
"KADIR":8680001572106,
"ATALAY":8680001290864,
"GOZTEPE MURAT":8680001282135,
"SELALE":8680001467822,
"CUHADAR":8680001335022,
"EMRE":8680001289813,
"SAYE":8680001664207,
"KARANFIL":8680001282043,
"LAVANTA":8680001285938,
"DILARA":8680001290826,
"TULAY":8680001285976,
"GECIT":8680001285860,
"HATIPOGLU":8680001286140,
"KARACA":8680001197187,
"OZDE":8680001527809,
"SALIHAN AKYILDIZ":8680001673285,
"HAYAT":8680001295517,
"SONMEZ":8680001291496,
"GUNGOR":8680001594443,
"ERIM":8680001286119,
"GULCIN":8680001293360,
"SIMIN":8680001285198,
"SIMYA":8680001394142,
"OKSIJEN":8680001134205,
"NIHAN":8680001438426,
"KAYA":8680001289523,
"GULERMAN":8680001291298,
"CIFTEHAVUZLAR":8680001669509,
"CADDEBOSTAN NAR":8680001234547,
"SARUHAN":8680001293742,
"GOZTEPE SOYLU":8680001217717,
"HEKIM":8680001481170,
"YASAM":8680001339853,
"DOGRUYOL":8680001640720,
"SENA":8680001293438,
"YESILBAHAR":8680001282500,
"VIZYON":8680001293575,
"CANAN ODABASI":8680001286089,
"SIMIRNA":8680001381449,
"ELIF":8680001455409,
"ORKUN":8680001289301,
"NIHAL":8680001294749,
"ECEM RAMIZ":8680001692088
}


barkod_dict={

"ALEVE 220 MG. 20 FILM KAPLI TABLET":8699546098248,
"ALKA SELTZER, 10 EFF. TABLET":8699546070879,
"ASPI NATURA IZOTONIK BURUN SPREYI 3,5% SPH 20 ML TR":8699546540020,
"ASPINATURA COUGH SYRUP 120ML BOTTLE":8699546578085,
"ASPINATURA KIDS COUGH SYRUP 120ML BOTTLE":8699546578078,
"ASPINATURA APRICOT LEMON SPRA PUB20ML TR":8699546650057,
"ASPINATURA COUGH SYRU SACH 10ML TR":8699546578092,
"ASPINATURA JUNIOR COUGH SYRU SACH 5ML TR":8699546578108,
"ASPINATURA LEMON-MINT SPRA PUB 20ML TR":8699546650064,
"ASPIRIN 0.5G, 20 TABLET":8699546010011,
"ASPIRIN 100MG, 20 TABLET":8699546010028,
"ASPIRIN COMPLEX ORAL SUSP.GRANULU 500/30MG. 10 SASE":8699546241231,
"ASPIRIN COMPLEX ORAL SUSP.GRANULU 500/30MG. 20 SASE":8699546241248,
"ASPIRIN PLUS C, 10 EFF. TABLET":8699546020478,
"BENEXOL B12 30 FILM KAPLI TABLET":8699546099429,
"BENEXOL B12 50 FILM KAPLI TABLET":8699546095100,
"BENICAL 100 CC SURUP":8699546575114,
"BENICAL COLD TAFI 20 TR":8699546095131,
"BEPANJEL GEL TUBE 50G TR":8699546340057,
"BEPANTHEN 5 AMPUL":8699546755141,
"BEPANTHEN PASTIL 100MG. 20 TAB.":8699546115198,
"BEPANTHEN PLUS 30G KREM":8699546355174,
"BEPANTHOL ANTI-SCAR JEL 20G.":8699546340040,
"BEPANTHOL BABY PISIK ONLEYICI MERHEM 100GR.":8699546370382,
"BEPANTHOL BABY PISIK ONLEYICI MERHEM 100GR./ISLAK MENDIL HEDIYELI COMBO":8699546370597,
"BEPANTHOL BABY PISIK ONLEYICI MERHEM 2X100G TR COMBO":8699546370023,
"BEPANTHOL BABY PISIK ONLEYICI MERHEM 30GR.":8699546370399,
"BEPANTHOL BABY PISIK ONLEYICI MERHEM 50GR.":8699546370429,
"BEPANTHOL CILT BAKIM KREMI 100GR.":8699546358632,
"BEPANTHOL CILT BAKIM KREMI 30GR.":8699546358625,
"BEPANTHOL CILT BAKIM KREMI 50GR.":8699546358694,
"BEPANTHOL DERMA ARINDIRICI & CANLANDIRICI GUNLUK YUZ TEMIZLEME JELI 200ML":8699546340071,
"BEPANTHOL DERMA NEM & BESLEYICI SPF 25 GUNES KORUYUCULU GUNLUK YUZ BAKIM KR 50ML":8699546358786,
"BEPANTHOL DERMA NEMLENDIRICI & BESLEYICI GUNLUK YUZ BAKIM KREMI":8699546358830,
"BEPANTHOL DERMA TEMEL NEMLENDIRICI GUNLUK VUCUT LOSYONU 200 ML":8699546485246,
"BEPANTHOL DERMA TEMEL NEMLENDIRICI GUNLUK VUCUT LOSYONU 400ML TR":8699546485260,
"BEPANTHOL DERMA YOGUN NEMLENDIRICI GECE BAKIM KREMI 50ML":8699546358779,
"BEPANTHOL DERMA YOGUN NEMLENDIRICI GUNLUK VUCUT LOSYONU 200 ML":8699546485253,
"BEPANTHOL DERMA YOGUN NEMLENDIRICI GUNLUK VUCUT LOSYONU 400ML TR":8699546485277,
"BEPANTHOL DUDAK BAKIM KREMI 7,5 ML":8699546350209,
"BEPANTHOL LIPSTICK GUNES KORUYUCU DUDAK BAKIM KREMI 4,5 GR.":8699546630004,
"BEPANTHOL ONARICI BAKIM MERHEMI 30GR.":8699546370580,
"BEPANTHOL ONARICI BAKIM MERHEMI 50GR.":8699546370412,
"BEPANTHOL SENSIDAILY 400ML VUCUT KREMI (POMPALI)":8699546358700,
"BEPANTHOL SENSIDAILY VUCUT KREMI 200ML":8699546358823,
"BEPANTHOLEYE NEMLENDIRICI GOZ DAMLASI - COKLU DOZ 10ML":8699546610044,
"BEPANTHOLEYE NEMLENDIRICI GOZ DAMLASI - TEKLI DOZ 20X0.5ML":8699546610037,
"BEPANTHOLSENSIDERM KASINTI GIDERICI KREM 20G.":8699546350223,
"BEPANTHOLSENSIDERM KASINTI GIDERICI KREM 50G.":8699546350230,
"BPL BABY 100 GR + FISHER PRICE SILIKON MAVI KASIK HEDIYELI ON PACK":8699546370573,
"BPL BABY PISIK ONLEYICI MERHEM 30G+100GR. COMBO":8699546370481,
"BPL CILT BAKIM 100 GR + BPL30 SPF LIP STICK / LACIVERT CANTALI COMBO":8699546358748,
"BPL SKINCARE 30G&OINT 30G&LIPCREA7.5G TR (BPL AVANTAJLI GUNLUK BAK.SET)":8699546350216,
"CANESTEN %1, 20G KREM":8699546350940,
"CLARINASE REPETABS, 20 TABLET":8699546032532,
"CLARITINE 10MG., 20 TABLET":8699546015634,
"ELENATAL 1,30 FILM KAPLI TABLET":8699546090426,
"ELENATAL 2 (STORK) OMEGA BLI 30 RPC TR":8699546190386,
"ELENATAL 3 CAPS 30 MVIT. MIN&OME3 TR":8699546190362,
"ELENATAL CAPS30+BEPANTHOLBABY OINT 20GTR":8699546094196,
"ELEVIT PRONATAL 30 FILM KAPLI TABLET":8699546091959,
"ELEVIT PRONATAL 60 FILM KAPLI TABLET":8699546095933,
"GYNO CANESTEN, 0.5G, 1 VAG. TABLET":8699546100354,
"MADECASSOL %1 40G MERHEM":8699546385492,
"MINOSET 150MG/5 ML 100 ML PEDIATRIK SURUP":8699546575589,
"MINOSET 500 MG 20 TABLET":8699546015597,
"MINOSET  PLUS 30 TABLET":8699546015610,
"MYCOSPOR %1, 10G KREM":8699546351411,
"PRIORIN INTENSE 120 KAPSUL":8699546196319,
"PRIORIN INTENSE 60 KAPSUL":8699546196234,
"PRIORIN INTENSE AVANTAJ PAKETI (120+60 KAPSUL)":8699546159512,
"REDOX-C AMPUL 500MG. 5":8699546755714,
"REDOXON 3'LU ETKI 15 EFERVESAN TABLET":8699546020447,
"REDOXON 3'LU ETKI 30 EFERVESAN TABLET":8699546020454,
"REDOXON C VIT 1000MG TAEF TUR 15 TR":8699546020461,
"REDOXON ESSENTIAL 1000MG TAEF TUBE 15 TR":8699546020461,
"REDOXON KIDS 60":8699546080045,
"REDOXON PROFESSIONAL TAEF TUR 15 TR":8699546020492,
"REDOXON UCLU ETKI 24'LU SASE":8699546020508,
"REDOXONESS+PRO+TRIPLEA+KID COMBO":8699546020522,
"RENNIE 100 ML SUSPANSIYON":8699546705757,
"RENNIE 48 CIGNEME TABLETI":8699546085767,
"RENNIE DUO 100 ML SUSPANSIYON":8699546705795,
"RENNIE DUO SUSP BT 200ML TR":8699546705801,
"SUPRADYN 15 EFFERVESAN TABLET":8699546020393,
"SUPRADYN 30 +15 EFFERVESAN TABLET COMBO  AVANTAJ PAKETI":8699546020430,
"SUPRADYN 30 EFFERVESAN TABLET":8699546020386,
"SUPRADYN COQ10 FCT 30 FILM KAPLI TABLET":8699546090396,
"SUPRADYN COQ10 TAFI BT 60 TR":8699546093939,
"SUPRADYN ENERGY FAST ACTION 10":8699546258260,
"SUPRADYN FOCUS TAFI BT 30 TR":8699546094134,
"SUPRADYN KIDS MAGIC BEANS TSCH 60 TR":8699546080069,
"SUPRAVIT PEDIATRIK 100 CC SURUP":8699546575893,
"TALCID 0.5G, 40 CIGNEME TABLETI":8699546080274,
"TALCID 0.5G/5ML, 200ML SUSPANSIYON":8699546700288

}

ecz=fin["ECZANE ADI"].tolist()
eczkod=[eczane_dict.get(item,item) for item in ecz]
fin["GLN_GUNCEL"]=eczkod



urun=fin["ÜRÜN ADI"].tolist()
urunkod=[barkod_dict.get(item,item) for item in urun]
fin["BARKOD_GUNCEL"]=urunkod


del fin["GLN"]
del fin["BARKOD"]
##########################################################################################################################################################################################



df = fin.groupby(['DEPO GRUBU','ECZANE ADI','GLN_GUNCEL','ÜRÜN ADI','BARKOD_GUNCEL'])['ADET','MF'].sum().reset_index()


inputs = [v for k, v in df.groupby('DEPO GRUBU')]



#DEPOLAR
#depo_query="/Users/islekbro/Desktop/dilos2/depo/"
depo_files = os.listdir(depo_query)

depo_dfs=[]
for i in depo_files:
	v = pd.read_csv(depo_query+i,sep=";")
	v = v.fillna(0)
	v = v[['GLN_GUNCEL', 'BARKOD_GUNCEL', 'ADET', 'MF']]
	v = v.astype(int)
	v = v.groupby(['GLN_GUNCEL','BARKOD_GUNCEL'])['ADET','MF'].sum().reset_index()
	if i.split(".")[0].upper() =="HEDEF":
		v["DEPO GRUBU"]="AH MARMARA"
	elif i.split(".")[0].upper() =="SANCAKTEPE":
		v["DEPO GRUBU"]="AS SANCAKTEPE"
	else:
		v["DEPO GRUBU"]=str(i).split(".")[0].upper()
	depo_dfs.append(v)

depo_fin=pd.concat(depo_dfs)
depos=[v for k, v in depo_fin.groupby('DEPO GRUBU')]




merged_dfs=[]
for i in inputs:
	for j in depos:
		if i['DEPO GRUBU'].unique() == j['DEPO GRUBU'].unique():
			i = i[['DEPO GRUBU', 'ECZANE ADI', 'GLN_GUNCEL' , 'ÜRÜN ADI', 'BARKOD_GUNCEL', 'ADET', 'MF']]
			j = j[['GLN_GUNCEL', 'BARKOD_GUNCEL', 'ADET', 'MF']]
			merged = pd.merge(i, j, how="left", on=['GLN_GUNCEL','BARKOD_GUNCEL'])
			merged=merged.fillna(0)
			merged = merged.rename({'DEPO GRUBU_x':'DEPO GRUBU','GLN_GUNCEL':'GLN','BARKOD_GUNCEL':'BARKOD','ADET_x': 'KESILEN (ADET)','MF_x': 'KESILEN (MF)','ADET_y': 'DEPODAN CIKAN (ADET)','MF_y': 'DEPODAN CIKAN (MF)'}, axis=1)
			merged = merged.astype({'DEPO GRUBU':object, 'ECZANE ADI':object, 'GLN':int, 'ÜRÜN ADI':object, 'BARKOD':int, 'KESILEN (ADET)':int, 'KESILEN (MF)': int, 'DEPODAN CIKAN (ADET)':int, 'DEPODAN CIKAN (MF)': int})
			merged_dfs.append(merged)
merged_total=pd.concat(merged_dfs)


input_set=set(df["DEPO GRUBU"].tolist())
depo_set=set(depo_fin["DEPO GRUBU"].tolist())

diff=input_set.difference(depo_set)

diff_dfs=[]
if len(diff)>0:
	for i in list(diff):
		x=df.loc[df['DEPO GRUBU']==i]
		diff_dfs.append(x)

df_extra=pd.concat(diff_dfs)
df_extra = df_extra.rename({'GLN_GUNCEL':'GLN','BARKOD_GUNCEL':'BARKOD','ADET': 'KESILEN (ADET)','MF': 'KESILEN (MF)'}, axis=1)


total=pd.concat([merged_total,df_extra])
total=total.fillna(0)
total = total.astype({'DEPO GRUBU':object, 'ECZANE ADI':object, 'GLN':int, 'ÜRÜN ADI':object, 'BARKOD':int, 'KESILEN (ADET)':int, 'KESILEN (MF)': int, 'DEPODAN CIKAN (ADET)':int, 'DEPODAN CIKAN (MF)': int})



final=total.astype(str)
final["KESILEN"]=final["KESILEN (ADET)"]+"+"+final["KESILEN (MF)"]
del final["KESILEN (ADET)"]
del final["KESILEN (MF)"]

final["DEPODAN CIKAN"]=final["DEPODAN CIKAN (ADET)"]+"+"+final["DEPODAN CIKAN (MF)"]
del final["DEPODAN CIKAN (ADET)"]
del final["DEPODAN CIKAN (MF)"]

final["CHECK"]=final['KESILEN'].str.strip().str.lower() == final['DEPODAN CIKAN'].str.strip().str.lower()


#out="/Users/islekbro/Desktop/dilos2/outputs/finallooo.csv"
final.to_csv(outfile,sep=";")


